<project name="hazy-sim-build">
    <!-- Move the robot source and the fake simulated files into a temporary
    directory for compilation    -->
    <target name="move">
        <mkdir dir="simsrc"/>
        <copy todir="simsrc">
            <fileset dir="sim"/>
        </copy>
        <copy todir="simsrc">
            <fileset dir="src">
                <exclude name="**/hardware/**"/>
                <exclude name="**/HazyJoystick.java"/>
                <exclude name="**/HazyIterative.java"/>
            </fileset>
        </copy>
    </target>
    
    <target name="simcompile" depends="move">
        <mkdir dir="simbuild"/>
        <path id="simclasspath.path">
            <fileset file="${networktables.jar}"/>
            <fileset file="jinput/jinput.jar"/>
            <fileset file="lib/SmartDashboard.jar"/>
        </path>
       
        <javac srcdir="simsrc"
               destdir="simbuild"
               includeAntRuntime="no"
               includeJavaRuntime="no"
               classpathref="simclasspath.path"
               target="${ant.java.version}"
               source="${ant.java.version}"
               compiler="javac${ant.java.version}"
               debug="true">
        </javac>
        
        <delete dir="simsrc"/>
        
    </target>
    
    <target name="simjar" depends="simcompile">
        <mkdir dir="simbuild/jars"/>
        <mkdir dir="simdist"/>
        
        <copy todir="simbuild/jars" flatten="true">
            <path refid="simclasspath.path"/>
        </copy>
        
        <jar destfile="simdist/HazySim.jar" update="false">
            <manifest>
                <attribute name="Main-Class" value="org/lasarobotics/frc2017/simrunner"/>
                <!-- <attribute name="Robot-Class" value="${robot.class}"/> -->
                <attribute name="Class-Path" value="."/>
            </manifest>
            
            <fileset dir="simbuild" includes="**/*.class"/>
            <zipgroupfileset dir="simbuild/jars"/>
        </jar>
        
        <copy todir="simdist">
            <fileset dir="jinput"/>
            <fileset dir="lib"/>
        </copy>
        
        <delete dir="simbuild"/>
        
    </target>

    <target name="simtest">
        <path id="simtestclasspath.path">
            <fileset file="${networktables.jar}"/>
            <fileset file="jinput/jinput.jar"/>
            <fileset file="lib/SmartDashboard.jar"/>
            <fileset file="lib/junit.jar"/>
            <fileset file="lib/ant-junit.jar"/>
        </path>
        <junit printsummary="yes" haltonfailure="no">
            <classpath refid="simtestclasspath.path"/>

            <batchtest fork="yes">
                <fileset dir=".">
                    <include name="**/*Test*.java"/>
                </fileset>
            </batchtest>
        </junit>
    </target>
    
    <path id="classpath.test">
        <fileset file="${networktables.jar}"/>
        <fileset file="jinput/jinput.jar"/>
        <fileset file="lib/SmartDashboard.jar"/>
        <fileset file="lib/junit.jar"/>
        <fileset file="lib/ant-junit.jar"/>
        <pathelement location="simbuild"/>
    </path>
    
    <target name="testcompile" depends="simcompile">
        <mkdir dir="simbuild/test"/>
        <javac srcdir="test" destdir="simbuild/test" includeantruntime="false">
            <classpath refid="classpath.test"/>
        </javac>
    </target>
    
    <target name="testboi" depends="testcompile">
        <junit printsummary="on" haltonfailure="no" fork="yes">
            <classpath>
                <path refid="classpath.test"/>
                <pathelement location="simbuild/test"/>
            </classpath>
            
            <batchtest>
                <formatter type="xml" usefile="true" />
                <fileset dir="simbuild/test" includes="**/*Test*.class" />
            </batchtest>
        </junit>
    </target>
    
    <target name="simulate" depends="simjar">
        <echo> Now we just gotta run it</echo>
        <java dir="simdist" jar="simdist/HazySim.jar" fork="true">
            
        </java>
    </target>
    
</project>
